# iOS CI/CD Pipeline using Fastlane
# Builds, tests, and deploys to TestFlight

name: iOS CI

on:
  push:
    branches: [main, develop, rebuild/swiftui-clean-impl]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

env:
  XCODE_VERSION: "26.2"

jobs:
  # ─────────────────────────────────────────────────────────────
  # Build and Test
  # ─────────────────────────────────────────────────────────────
  build-and-test:
    name: Build and Test
    runs-on: macos-15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_${{ env.XCODE_VERSION }}.app

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.2"
          bundler-cache: true

      - name: Clean DerivedData
        run: |
          echo "Cleaning DerivedData to ensure fresh build..."
          rm -rf ~/Library/Developer/Xcode/DerivedData
          echo "DerivedData cleaned successfully"

      - name: Build (no signing)
        run: |
          set -o pipefail
          # `xcpretty` sometimes omits the underlying compiler error output.
          # `xcpretty` sometimes omits the underlying compiler error output.
          # Keep a raw log and print its tail on failure for easier debugging in CI.
          xcodebuild clean build \
            -project FamilyTodo.xcodeproj \
            -scheme HousePulse \
            -destination "platform=iOS Simulator,name=iPhone 16,OS=18.5" \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            ARCHS=arm64 \
            ONLY_ACTIVE_ARCH=YES \
            OTHER_SWIFT_FLAGS='$(inherited) -D CI' \
            2>&1 | tee xcodebuild-build.log | bundle exec xcpretty || { \
              status=$?; \
              echo "::group::xcodebuild-build.log (tail)"; \
              tail -n 200 xcodebuild-build.log || true; \
              echo "::endgroup::"; \
              exit $status; \
            }

      - name: Run tests
        run: |
          set -o pipefail
          xcodebuild test \
            -project FamilyTodo.xcodeproj \
            -scheme HousePulse \
            -destination "platform=iOS Simulator,name=iPhone 16,OS=18.5" \
            -only-testing:FamilyTodoTests \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            ARCHS=arm64 \
            ONLY_ACTIVE_ARCH=YES \
            OTHER_SWIFT_FLAGS='$(inherited) -D CI' \
            2>&1 | tee xcodebuild-test.log | bundle exec xcpretty || { \
              status=$?; \
              echo "::group::xcodebuild-test.log (tail)"; \
              tail -n 200 xcodebuild-test.log || true; \
              echo "::endgroup::"; \
              exit $status; \
            }

      - name: Run UI tests (app launch verification)
        run: |
          set -o pipefail
          xcodebuild test \
            -project FamilyTodo.xcodeproj \
            -scheme HousePulse \
            -destination "platform=iOS Simulator,name=iPhone 16,OS=18.5" \
            -only-testing:FamilyTodoUITests \
            -skip-testing:FamilyTodoUITests/FamilyTodoPerformanceTests \
            -resultBundlePath TestResults.xcresult \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            ARCHS=arm64 \
            ONLY_ACTIVE_ARCH=YES \
            2>&1 | tee xcodebuild-uitest.log | bundle exec xcpretty || { \
              status=$?; \
              echo "::group::xcodebuild-uitest.log (tail)"; \
              tail -n 200 xcodebuild-uitest.log || true; \
              echo "::endgroup::"; \
              exit $status; \
            }

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: HousePulse-TestResults
          path: TestResults.xcresult

  # ─────────────────────────────────────────────────────────────
  # SwiftLint
  # ─────────────────────────────────────────────────────────────
  swiftlint:
    name: SwiftLint
    runs-on: macos-15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install SwiftLint
        run: brew install swiftlint

      - name: Run SwiftLint
        run: swiftlint lint --reporter github-actions-logging

  # ─────────────────────────────────────────────────────────────
  # Deploy to TestFlight (Fastlane) — disabled until credentials exist
  # ─────────────────────────────────────────────────────────────
  deploy-testflight:
    name: Deploy to TestFlight
    runs-on: macos-15
    needs: [build-and-test, swiftlint]
    # Only run on manual dispatch or tags starting with 'v'
    if: github.event_name == 'workflow_dispatch' || startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_${{ env.XCODE_VERSION }}.app

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.2"
          bundler-cache: true

      - name: Install signing certificate and provisioning profile
        env:
          BUILD_CERTIFICATE_BASE64: ${{ secrets.BUILD_CERTIFICATE_BASE64 }}
          P12_PASSWORD: ${{ secrets.P12_PASSWORD }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
          PROVISIONING_PROFILE_BASE64: ${{ secrets.PROVISIONING_PROFILE_BASE64 }}
        run: |
          set -euo pipefail

          decode_base64() {
            # GNU coreutils uses `--decode`, macOS uses `-D`. Support both.
            if base64 --help 2>/dev/null | grep -q -- '--decode'; then
              base64 --decode
            else
              base64 -D
            fi
          }

          KEYCHAIN_PATH="$RUNNER_TEMP/build.keychain-db"

          # Create and configure a dedicated keychain for CI
          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security default-keychain -s "$KEYCHAIN_PATH"
          security list-keychains -d user -s "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"

          # Import certificate (.p12) into keychain
          CERT_PATH="$RUNNER_TEMP/certificate.p12"
          echo "$BUILD_CERTIFICATE_BASE64" | decode_base64 > "$CERT_PATH"
          # Validate the PKCS#12 upfront to fail with a clearer error message.
          openssl pkcs12 -info -in "$CERT_PATH" -passin pass:"$P12_PASSWORD" -noout >/dev/null

          # `-A` avoids interactive prompts ("User interaction is not allowed") during codesign in CI.
          # The import may output "Cannot parse a NULL or zero-length data" warning to stderr,
          # but the identity is still imported successfully. Redirect stderr to avoid pipefail issues.
          security import "$CERT_PATH" -k "$KEYCHAIN_PATH" -P "$P12_PASSWORD" -A -T /usr/bin/codesign -T /usr/bin/security 2>&1 || true

          # Verify the certificate was imported (also redirect stderr)
          IDENTITIES=$(security find-identity -v -p codesigning "$KEYCHAIN_PATH" 2>&1 || true)
          echo "$IDENTITIES"
          if ! echo "$IDENTITIES" | grep -q "Apple Distribution"; then
            echo "::error::Failed to import signing certificate"
            exit 1
          fi
          echo "Certificate verified successfully"

          # Install provisioning profile
          PROFILE_PATH="$RUNNER_TEMP/profile.mobileprovision"
          echo "$PROVISIONING_PROFILE_BASE64" | decode_base64 > "$PROFILE_PATH"

          # Extract profile plist (security cms may output warnings to stderr)
          PROFILE_PLIST=$(security cms -D -i "$PROFILE_PATH" 2>/dev/null)
          PROFILE_UUID=$(echo "$PROFILE_PLIST" | /usr/libexec/PlistBuddy -c 'Print UUID' /dev/stdin)
          PROFILE_NAME=$(echo "$PROFILE_PLIST" | /usr/libexec/PlistBuddy -c 'Print Name' /dev/stdin)

          mkdir -p "$HOME/Library/MobileDevice/Provisioning Profiles"
          cp "$PROFILE_PATH" "$HOME/Library/MobileDevice/Provisioning Profiles/${PROFILE_UUID}.mobileprovision"

          # Debug: show installed profile
          echo "Profile: $PROFILE_NAME"
          echo "UUID: $PROFILE_UUID"

      - name: Deploy to TestFlight
        env:
          # App Store Connect API Key (create at App Store Connect → Users → Keys)
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_API_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_ISSUER_ID }}
          APP_STORE_CONNECT_API_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_API_KEY_CONTENT }}
          # App configuration
          APP_IDENTIFIER: ${{ secrets.APP_IDENTIFIER }}
          TEAM_ID: ${{ secrets.TEAM_ID }}
          PROVISIONING_PROFILE_NAME: ${{ secrets.PROVISIONING_PROFILE_NAME }}
          # Build number from GitHub run
          BUILD_NUMBER: ${{ github.run_number }}
          # Use the keychain we created in CI (avoid fastlane creating another)
          SKIP_FASTLANE_SETUP_CI: "1"
        run: bundle exec fastlane beta

      - name: Upload IPA
        uses: actions/upload-artifact@v4
        with:
          name: HousePulse-IPA
          path: build/HousePulse.ipa
          retention-days: 30

  # ─────────────────────────────────────────────────────────────
  # Notify on failure
  # ─────────────────────────────────────────────────────────────
  notify-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [build-and-test, swiftlint]
    if: failure()

    steps:
      - name: Log failure
        run: |
          echo "Build or tests failed!"
          echo "Check: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
