# iOS CI/CD Pipeline using Fastlane
# Builds, tests, and deploys to TestFlight

name: iOS CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

env:
  XCODE_VERSION: '15.2'

jobs:
  # ─────────────────────────────────────────────────────────────
  # Build and Test
  # ─────────────────────────────────────────────────────────────
  build-and-test:
    name: Build and Test
    runs-on: macos-14

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_${{ env.XCODE_VERSION }}.app

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true

      - name: Build (no signing)
        run: |
          # `xcpretty` sometimes omits the underlying compiler error output.
          # Keep a raw log and print its tail on failure for easier debugging in CI.
          xcodebuild clean build \
            -project FamilyTodo.xcodeproj \
            -scheme HousePulse \
            -destination "platform=iOS Simulator,name=iPhone 15,OS=17.2" \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            ARCHS=arm64 \
            ONLY_ACTIVE_ARCH=YES \
            OTHER_SWIFT_FLAGS='$(inherited) -D CI' \
            2>&1 | tee xcodebuild-build.log | bundle exec xcpretty || { \
              status=$?; \
              echo "::group::xcodebuild-build.log (tail)"; \
              tail -n 200 xcodebuild-build.log || true; \
              echo "::endgroup::"; \
              exit $status; \
            }

      - name: Run tests
        run: |
          xcodebuild test \
            -project FamilyTodo.xcodeproj \
            -scheme HousePulse \
            -destination "platform=iOS Simulator,name=iPhone 15,OS=17.2" \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            ARCHS=arm64 \
            ONLY_ACTIVE_ARCH=YES \
            OTHER_SWIFT_FLAGS='$(inherited) -D CI' \
            2>&1 | tee xcodebuild-test.log | bundle exec xcpretty || { \
              status=$?; \
              echo "::group::xcodebuild-test.log (tail)"; \
              tail -n 200 xcodebuild-test.log || true; \
              echo "::endgroup::"; \
              exit $status; \
            }

  # ─────────────────────────────────────────────────────────────
  # SwiftLint
  # ─────────────────────────────────────────────────────────────
  swiftlint:
    name: SwiftLint
    runs-on: macos-14

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install SwiftLint
        run: brew install swiftlint

      - name: Run SwiftLint
        run: swiftlint lint --reporter github-actions-logging

  # ─────────────────────────────────────────────────────────────
  # Deploy to TestFlight (Fastlane) — disabled until credentials exist
  # ─────────────────────────────────────────────────────────────
  # deploy-testflight:
  #   name: Deploy to TestFlight
  #   runs-on: macos-14
  #   needs: [build-and-test, swiftlint]
  #   if: github.ref == 'refs/heads/main' && github.event_name == 'push'
  #
  #   steps:
  #     - name: Checkout
  #       uses: actions/checkout@v4
  #
  #     - name: Select Xcode
  #       run: sudo xcode-select -s /Applications/Xcode_${{ env.XCODE_VERSION }}.app
  #
  #     - name: Setup Ruby
  #       uses: ruby/setup-ruby@v1
  #       with:
  #         ruby-version: '3.2'
  #         bundler-cache: true
  #
  #     - name: Deploy to TestFlight
  #       env:
  #         # App Store Connect API Key (create at App Store Connect → Users → Keys)
  #         APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
  #         APP_STORE_CONNECT_API_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_ISSUER_ID }}
  #         APP_STORE_CONNECT_API_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_API_KEY_CONTENT }}
  #         # App configuration
  #         APP_IDENTIFIER: ${{ secrets.APP_IDENTIFIER }}
  #         TEAM_ID: ${{ secrets.TEAM_ID }}
  #         # Build number from GitHub run
  #         BUILD_NUMBER: ${{ github.run_number }}
  #       run: bundle exec fastlane beta
  #
  #     - name: Upload IPA
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: HousePulse-IPA
  #         path: build/HousePulse.ipa
  #         retention-days: 30

  # ─────────────────────────────────────────────────────────────
  # Notify on failure
  # ─────────────────────────────────────────────────────────────
  notify-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [build-and-test, swiftlint]
    if: failure()

    steps:
      - name: Log failure
        run: |
          echo "Build or tests failed!"
          echo "Check: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
