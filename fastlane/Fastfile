default_platform(:ios)

platform :ios do
  # ─────────────────────────────────────────────────────────────
  # Configuration
  # ─────────────────────────────────────────────────────────────

  SCHEME = "HousePulse"
  PROJECT = "FamilyTodo.xcodeproj"

  before_all do
    setup_ci if ENV["CI"]
  end

  # ─────────────────────────────────────────────────────────────
  # Build & Test
  # ─────────────────────────────────────────────────────────────

  desc "Run tests"
  lane :test do
    run_tests(
      project: PROJECT,
      scheme: SCHEME,
      device: "iPhone 15",
      clean: true
    )
  end

  desc "Build for testing (no signing)"
  lane :build do
    build_app(
      project: PROJECT,
      scheme: SCHEME,
      skip_codesigning: true,
      skip_archive: true,
      destination: "generic/platform=iOS Simulator"
    )
  end

  # ─────────────────────────────────────────────────────────────
  # TestFlight
  # ─────────────────────────────────────────────────────────────

  desc "Build and upload to TestFlight"
  lane :beta do
    # Configure API key from environment
    api_key = app_store_connect_api_key(
      key_id: ENV["APP_STORE_CONNECT_API_KEY_ID"],
      issuer_id: ENV["APP_STORE_CONNECT_API_ISSUER_ID"],
      key_content: ENV["APP_STORE_CONNECT_API_KEY_CONTENT"],
      is_key_content_base64: true,
      in_house: false
    )

    app_identifier = ENV["APP_IDENTIFIER"]
    team_id = ENV["TEAM_ID"]
    profile_name = ENV["PROVISIONING_PROFILE_NAME"]
    profile_name_escaped = profile_name.to_s.gsub('"', '\"')

    if app_identifier.to_s.empty? || team_id.to_s.empty? || profile_name.to_s.empty?
      UI.user_error!("Missing signing env vars: APP_IDENTIFIER, TEAM_ID, PROVISIONING_PROFILE_NAME")
    end

    # Increment build number
    increment_build_number(
      build_number: ENV["BUILD_NUMBER"] || Time.now.strftime("%Y%m%d%H%M")
    )

    # Build
    build_app(
      project: PROJECT,
      scheme: SCHEME,
      export_method: "app-store",
      export_options: {
        signingStyle: "manual",
        teamID: team_id,
        provisioningProfiles: {
          app_identifier => profile_name,
        },
      },
      xcargs: [
        "PRODUCT_BUNDLE_IDENTIFIER=#{app_identifier}",
        "DEVELOPMENT_TEAM=#{team_id}",
        "CODE_SIGN_STYLE=Manual",
        "PROVISIONING_PROFILE_SPECIFIER=\"#{profile_name_escaped}\"",
        "CODE_SIGN_IDENTITY=Apple Distribution",
      ].join(" "),
      output_directory: "./build",
      output_name: "HousePulse.ipa"
    )

    # Upload to TestFlight
    upload_to_testflight(
      api_key: api_key,
      skip_waiting_for_build_processing: true,
      distribute_external: false
    )
  end

  # ─────────────────────────────────────────────────────────────
  # App Store Release
  # ─────────────────────────────────────────────────────────────

  desc "Build and upload to App Store (manual release)"
  lane :release do
    api_key = app_store_connect_api_key(
      key_id: ENV["APP_STORE_CONNECT_API_KEY_ID"],
      issuer_id: ENV["APP_STORE_CONNECT_API_ISSUER_ID"],
      key_content: ENV["APP_STORE_CONNECT_API_KEY_CONTENT"],
      is_key_content_base64: true,
      in_house: false
    )

    # Ensure we're on main branch
    ensure_git_branch(branch: "main")
    ensure_git_status_clean

    # Increment version
    increment_build_number(
      build_number: Time.now.strftime("%Y%m%d%H%M")
    )

    # Build
    build_app(
      project: PROJECT,
      scheme: SCHEME,
      export_method: "app-store",
      output_directory: "./build",
      output_name: "HousePulse.ipa"
    )

    # Upload to App Store
    upload_to_app_store(
      api_key: api_key,
      skip_metadata: true,
      skip_screenshots: true,
      submit_for_review: false,
      automatic_release: false
    )
  end

  # ─────────────────────────────────────────────────────────────
  # Utilities
  # ─────────────────────────────────────────────────────────────

  desc "Sync certificates and profiles (for local development)"
  lane :sync_certs do
    # This requires match to be configured with a certificates repo
    # Uncomment when ready:
    # match(type: "development")
    # match(type: "appstore")
    UI.message("Match not configured yet. Set up a certificates repo first.")
  end

  # ─────────────────────────────────────────────────────────────
  # Error handling
  # ─────────────────────────────────────────────────────────────

  error do |lane, exception|
    UI.error("Lane #{lane} failed with error: #{exception.message}")
  end
end
